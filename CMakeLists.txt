# CMake version configuration
cmake_minimum_required(VERSION 3.5...3.18)
if(${CMAKE_VERSION} VERSION_LESS 3.12)
    cmake_policy(VERSION ${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION})
endif()

# Define project
project(librepcb
    VERSION 0.1.5
    LANGUAGES CXX
)

# Global options
option(UNBUNDLE_CMARK "Don't use vendored cmark library." OFF)
option(UNBUNDLE_FONTOBENE_QT5 "Don't use vendored fontobene-qt5 library." OFF)
option(UNBUNDLE_ALL "Don't use any vendored library." OFF)
option(BUILD_TESTS "Build unit tests." ON)

# Force static linking for local libs
set(BUILD_SHARED_LIBS OFF CACHE BOOL "Link dynamically against local libraries." FORCE)

# Auto-include current directory
set(CMAKE_INCLUDE_CURRENT_DIR ON)

# Require out-of-source builds
file(TO_CMAKE_PATH "${PROJECT_BINARY_DIR}/CMakeLists.txt" LOC_PATH)
if(EXISTS "${LOC_PATH}")
    message(FATAL_ERROR "You cannot build in a source directory (or any directory with a CMakeLists.txt file). Please make a build subdirectory. Feel free to remove CMakeCache.txt and CMakeFiles.")
endif()

# Use C++11
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Configure module path
set(CMAKE_MODULE_PATH "${PROJECT_SOURCE_DIR}/cmake" ${CMAKE_MODULE_PATH})

# Include GNU install dirs variables
include(GNUInstallDirs)

# Find required Qt packages
find_package(Qt5 5.2.0 COMPONENTS Concurrent Gui Network OpenGL PrintSupport Sql Svg Widgets REQUIRED)
if(BUILD_TESTS)
    find_package(Qt5 5.2.0 COMPONENTS Test REQUIRED)
endif()

# Find third party libraries
find_package(DelaunayTriangulation REQUIRED)
find_package(FontoBeneQt5 REQUIRED)
find_package(MuParser REQUIRED)
find_package(Optional REQUIRED)
find_package(Polyclipping REQUIRED)
find_package(QuaZip REQUIRED)
find_package(TypeSafe REQUIRED)
if(BUILD_TESTS)
    find_package(GTest REQUIRED)
endif()
# Hoedown is only needed on Qt <5.14
if(Qt5Core_VERSION_MAJOR EQUAL 5 AND Qt5Core_VERSION_MINOR LESS 14)
    find_package(Hoedown REQUIRED)
endif()

# Add libs
add_subdirectory(libs/librepcb/common)
add_subdirectory(libs/librepcb/library)
add_subdirectory(libs/librepcb/project)
add_subdirectory(libs/librepcb/workspace)
add_subdirectory(libs/librepcb/projecteditor)
add_subdirectory(libs/librepcb/libraryeditor)
add_subdirectory(libs/librepcb/librarymanager)
add_subdirectory(libs/librepcb/eagleimport)
add_subdirectory(libs/parseagle)

# Add apps
add_subdirectory(apps/librepcb)
add_subdirectory(apps/librepcb-cli)
add_subdirectory(apps/UuidGenerator)
add_subdirectory(apps/EagleImport)

# Add unittests
if(BUILD_TESTS)
    add_subdirectory(tests/unittests)
endif()
